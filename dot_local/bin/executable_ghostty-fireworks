#!/usr/bin/env bash
# Test/trigger the Ghostty fireworks shader for a set duration

GHOSTTY_CONFIG="$HOME/.config/ghostty/config"
FIREWORKS_SHADER="shaders/fireworks.glsl"
NORMAL_SHADER="shaders/cursor_blaze.glsl"
DURATION="${1:-8}"

GHOSTTY_PROC_PID=$(ps -ax -o pid,comm | grep -i ghostty | grep -v grep | awk '{print $1}' | head -1)

# Swap to fireworks shader and reload
sed -i '' "s|custom-shader = ${NORMAL_SHADER}|custom-shader = ${FIREWORKS_SHADER}|g" "$GHOSTTY_CONFIG"
kill -USR2 "$GHOSTTY_PROC_PID"


RESTORE_SCRIPT=$(mktemp -t ghostty-restore)
cat > "$RESTORE_SCRIPT" << SCRIPT
#!/usr/bin/env bash
sed -i '' "s|custom-shader = ${FIREWORKS_SHADER}|custom-shader = ${NORMAL_SHADER}|g" "${GHOSTTY_CONFIG}"
kill -USR2 ${GHOSTTY_PROC_PID} 2>/dev/null
rm -f "\$0"
SCRIPT
chmod +x "$RESTORE_SCRIPT"

nohup bash -c "sleep ${DURATION} && bash ${RESTORE_SCRIPT}" >/dev/null 2>&1 &
